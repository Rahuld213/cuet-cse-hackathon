name: ğŸ›¡ï¸ Branch Protection

on:
  pull_request:
    branches: [main, master]

jobs:
  # ============================================================================
  # PR VALIDATION - Ensure PR meets requirements
  # ============================================================================
  pr-validation:
    name: ğŸ” PR Validation
    runs-on: ubuntu-24.04
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” Check PR title format
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          if [[ ! "$PR_TITLE" =~ ^(feat|fix|docs|style|refactor|test|chore)(\(.+\))?: .+ ]]; then
            echo "âŒ PR title must follow conventional commits format"
            echo "Examples: feat: add new feature, fix(api): resolve bug"
            exit 1
          fi
          echo "âœ… PR title format is valid"

      - name: ğŸ“Š Check changed files
        run: |
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
          echo "ğŸ“ Changed files:"
          echo "$CHANGED_FILES"

          # Check if critical files are modified
          if echo "$CHANGED_FILES" | grep -E "(package\.json|Dockerfile|docker-compose)" > /dev/null; then
            echo "âš ï¸ Critical files modified - extra review required"
          fi

      - name: ğŸ“ Check PR size
        run: |
          ADDITIONS=$(git diff --shortstat origin/${{ github.base_ref }}...HEAD | grep -oE '[0-9]+ insertions?' | grep -oE '[0-9]+' || echo "0")
          DELETIONS=$(git diff --shortstat origin/${{ github.base_ref }}...HEAD | grep -oE '[0-9]+ deletions?' | grep -oE '[0-9]+' || echo "0")
          TOTAL_CHANGES=$((ADDITIONS + DELETIONS))

          echo "ğŸ“Š PR Statistics:"
          echo "  Additions: $ADDITIONS"
          echo "  Deletions: $DELETIONS"
          echo "  Total changes: $TOTAL_CHANGES"

          if [ $TOTAL_CHANGES -gt 500 ]; then
            echo "âš ï¸ Large PR detected ($TOTAL_CHANGES lines). Consider breaking into smaller PRs."
          else
            echo "âœ… PR size is reasonable"
          fi

  # ============================================================================
  # DEPENDENCY CHECK - Verify no malicious dependencies
  # ============================================================================
  dependency-check:
    name: ğŸ”’ Dependency Security Check
    runs-on: ubuntu-24.04
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "24"

      - name: ğŸ” Audit dependencies
        run: |
          npm audit --audit-level=moderate
          echo "âœ… Dependency audit passed"

      - name: ğŸ“Š Check for outdated packages
        run: |
          npm outdated || true
          echo "â„¹ï¸ Outdated packages check completed"
